# Устранение проблемы с частыми запросами геолокации

## Проблема
Геолокация отправляется каждые 2 секунды вместо ожидаемых 10 секунд.

## Причины частых запросов

### 1. Малый distanceFilter
- **Было**: `DISTANCE_FILTER: 5` метров
- **Проблема**: При движении устройства или "дрожании" GPS события генерируются очень часто
- **Решение**: Увеличено до `DISTANCE_FILTER: 20` метров

### 2. Активные интервалы в backgroundService
- **Проблема**: `backgroundService` создавал дополнительные `setInterval` для отправки данных
- **Решение**: Полностью отключены все интервалы в `backgroundService`

### 3. Малый MAX_AGE
- **Было**: `MAX_AGE: 5000` мс (5 секунд)
- **Проблема**: Слишком частое обновление позиции
- **Решение**: Увеличено до `MAX_AGE: 10000` мс (10 секунд)

### 4. Инициализация backgroundService
- **Проблема**: `backgroundService` инициализировался в `App.js` и мог создавать дополнительные обработчики
- **Решение**: Отключена инициализация `backgroundService` в `App.js`

## Внесенные изменения

### 1. Обновлен `src/config/geoConfig.js`
```javascript
TEST_MODE: {
  DISTANCE_FILTER: 20, // Увеличено с 5 до 20 метров
  MAX_AGE: 10000,      // Увеличено с 5000 до 10000 мс
  // ... остальные настройки
}
```

### 2. Обновлен `src/services/backgroundService.js`
- Отключены все `setInterval` в методе `adjustGeoCollectionForBackground`
- Убраны активные интервалы для сбора и отправки данных
- Добавлено логирование об отключенных функциях

### 3. Обновлен `App.js`
- Отключена инициализация `backgroundService`
- Добавлено логирование об отключенном сервисе

## Текущая архитектура

Теперь геолокация работает по упрощенной схеме:

1. **BackgroundGeolocation** генерирует события с учетом:
   - `distanceFilter: 20` метров
   - `heartbeatInterval: 10` секунд
   - `MAX_AGE: 10` секунд

2. **location.js** получает события и отправляет геолокацию:
   - На webhook (если выбран webhook режим)
   - На API Django (если выбран API режим)

3. **backgroundService** полностью отключен

## Ожидаемая частота

- **Минимальная частота**: 10 секунд (heartbeatInterval)
- **Фактическая частота**: Зависит от движения устройства
- **При движении**: События генерируются при перемещении на 20+ метров
- **В покое**: События генерируются каждые 10 секунд

## Логи для отладки

Теперь в консоли должны быть видны:

```
BackgroundService initialization disabled - using location.js only for geo data
Initializing BackgroundGeolocation with config: {
  mode: 'TEST',
  distanceFilter: 20,
  heartbeatInterval: 10,
  stopTimeout: 0
}
App is active - interval strategy disabled, using location.js only
All intervals disabled - location data sent only via location.js direct API calls
```

## Проверка работы

1. **Запустите приложение** в режиме разработки
2. **Проверьте логи** в консоли Metro/React Native
3. **Должны быть видны** сообщения об отключенных интервалах
4. **Геолокация должна отправляться** не чаще чем каждые 10 секунд
5. **При движении** частота может увеличиться, но не более чем каждые 2-3 секунды

## Дополнительные настройки

Если запросы все еще слишком частые, можно дополнительно:

1. **Увеличить distanceFilter** до 50 метров
2. **Увеличить heartbeatInterval** до 30 секунд
3. **Увеличить MAX_AGE** до 30 секунд

## Откат изменений

Если нужно вернуть пакетную отправку:

1. В `App.js` раскомментировать инициализацию `backgroundService`
2. В `backgroundService.js` включить интервалы
3. В `location.js` включить отправку в `backgroundService`
