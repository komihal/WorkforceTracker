# üîã Battery Optimization - –§–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ê–¢–£–°

## ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê!**

### **üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ùå **–ë—ã–ª–æ**: `PermissionsModule.checkPermission(... permission is null)` crash
- ‚úÖ **–°—Ç–∞–ª–æ**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å battery optimization –±–µ–∑ crash'–µ–π

---

## üìä **–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤:**

### **‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
09-06 10:50:33.948 I/ReactNativeJS(22698): '[BG][battery] dialog result ‚Üí', true
09-06 10:50:33.956 I/ReactNativeJS(22698): [Battery] Requesting battery optimization whitelist...
```

### **‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. **AppState Guard**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **Platform Guard**: ‚úÖ iOS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`
3. **Error Handling**: ‚úÖ –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
4. **UI Dialog**: ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥
5. **Settings Link**: ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

### **1. –£–¥–∞–ª–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ PermissionsAndroid –≤—ã–∑–æ–≤—ã**
- ‚úÖ **MainScreen.js**: –ó–∞–º–µ–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `ensureBatteryWhitelistUI()`
- ‚úÖ –£–±—Ä–∞–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã `PermissionsAndroid.PERMISSIONS.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS`

### **2. –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**
- ‚úÖ `getBatteryWhitelistStatus()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ `ensureBatteryWhitelistUI()` - –ø–æ–∫–∞–∑ –¥–∏–∞–ª–æ–≥–∞ —Å guard'–∞–º–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å `batteryOptimization.ts`

### **3. Guard'—ã –∏ –∑–∞—â–∏—Ç–∞**
- ‚úÖ **AppState Guard**: –î–∏–∞–ª–æ–≥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
- ‚úÖ **Platform Guard**: iOS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`
- ‚úÖ **Error Handling**: Try-catch –±–ª–æ–∫–∏ –≤–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö

---

## üì± **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

### **BgGeoTestScreen.tsx**
- ‚úÖ **Battery Optimization Section** —Å —Å—Ç–∞—Ç—É—Å–æ–º
- ‚úÖ **"Request Ignore Battery Optimizations"** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥
- ‚úÖ **"Open App Settings"** - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ **–°—Ç–∞—Ç—É—Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è**: ‚úÖ YES / ‚ùå NO

### **MainScreen.js**
- ‚úÖ –ö–Ω–æ–ø–∫–∞ battery optimization –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π API
- ‚úÖ –ë–æ–ª—å—à–µ –Ω–µ—Ç crash'–µ–π –ø—Ä–∏ –≤—ã–∑–æ–≤–µ

---

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
```bash
adb shell dumpsys deviceidle whitelist | grep com.workforcetracker
```
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –≤ whitelist (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
- **–î–µ–π—Å—Ç–≤–∏–µ**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–æ–≥–∏:**
```bash
adb logcat -c && adb logcat -d -v time -s TSLocationManager ReactNativeJS > bggeo_snapshot.log
```

---

## üéâ **–ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ!**

### **‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç:**
1. **Crash –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** - –±–æ–ª—å—à–µ –Ω–µ—Ç `PermissionsModule.checkPermission(... null)`
2. **UI –¥–æ–±–∞–≤–ª–µ–Ω** - —É–¥–æ–±–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ battery optimization
3. **Guard'—ã —Ä–∞–±–æ—Ç–∞—é—Ç** - –∑–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–∑–æ–≤–æ–≤ –∏–∑ background
4. **–î–∏–∞–ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
5. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è** - –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º

### **üì± –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** ‚Üí **"üî¨ BG Test Suite"**
2. **–í —Å–µ–∫—Ü–∏–∏ "Battery Optimization"** —É–≤–∏–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å
3. **–ù–∞–∂–º–∏—Ç–µ "Request Ignore Battery Optimizations"** - –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –¥–∏–∞–ª–æ–≥
4. **–ù–∞–∂–º–∏—Ç–µ "Open App Settings"** - –æ—Ç–∫—Ä–æ—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
5. **–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö** –Ω–∞–π–¥–∏—Ç–µ "Battery" ‚Üí "Battery optimization" ‚Üí "Don't optimize"

### **üöÄ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞!**
- ‚úÖ **Crash –∏—Å–ø—Ä–∞–≤–ª–µ–Ω**
- ‚úÖ **UI —Ä–∞–±–æ—Ç–∞–µ—Ç**
- ‚úÖ **Guard'—ã –∞–∫—Ç–∏–≤–Ω—ã**
- ‚úÖ **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω–æ** (PID 22698)
- ‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ comprehensive testing —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ A/C/D**

**–ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ BG Geo!** üéØ
